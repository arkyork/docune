
<!-- PDF.js èª­ã¿è¾¼ã¿ -->
<script src="https://unpkg.com/pdfjs-dist@3/build/pdf.min.js"></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://unpkg.com/pdfjs-dist@3/build/pdf.worker.min.js";

  const url = "{{ ref.pdf.url }}";
  const container = document.getElementById("pdf-container");

  pdfjsLib.getDocument(url).promise.then(pdf => {
    for (let n = 1; n <= pdf.numPages; n++) {
      pdf.getPage(n).then(page => {
        const desiredWidth = container.clientWidth;
        const unscaledViewport = page.getViewport({ scale: 1 });
        const scale = desiredWidth / unscaledViewport.width;
        const viewport = page.getViewport({ scale });

        const canvas = document.createElement("canvas");
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        canvas.className = "mb-4 shadow w-full";
        container.appendChild(canvas);

        const ctx = canvas.getContext("2d");
        page.render({ canvasContext: ctx, viewport });
      });
    }
  });
</script>

<script>
  document.getElementById("similar-btn").addEventListener("click", async () => {
    const btn = document.getElementById("similar-btn");
    const list = document.getElementById("similar-list");
    const resultsDiv = document.getElementById("similar-results");
    const pk = {{ ref.pk }};
  
    btn.disabled = true;
    btn.textContent = "æ¤œç´¢ä¸­...";
  
    try {
      const res = await fetch(`/api/similar/${pk}/`);
      const data = await res.json();
      list.innerHTML = "";
  
      if (data.results && data.results.length > 0) {
        data.results.forEach(ref => {
          const li = document.createElement("li");
          li.innerHTML = `<a href="/${ref.id}/pdf/" class="text-blue-600 hover:underline">
                            ${ref.title}</a>ï¼ˆé¡ä¼¼åº¦: ${ref.score}ï¼‰`;
          list.appendChild(li);
        });
      } else {
        list.innerHTML = "<li>é¡ä¼¼æ–‡çŒ®ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</li>";
      }
  
      resultsDiv.classList.remove("hidden");
    } catch (err) {
      alert("é¡ä¼¼æ–‡çŒ®ã®æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ");
      console.error(err);
    } finally {
      btn.textContent = "ğŸ” é¡ä¼¼æ–‡çŒ®ã‚’æ¢ã™";
      btn.disabled = false;
    }
  });
  </script>